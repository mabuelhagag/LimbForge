function init(){container=document.createElement("div"),document.body.appendChild(container),camera=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,15e3),camera.position.set(300,150,300),cameraTarget=new THREE.Vector3(0,0,0),scene=new THREE.Scene,scene.add(new THREE.HemisphereLight(4469555,1118498)),addShadowedLight(.5,1,-1,16777113,1),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setClearColor(16777215),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.gammaInput=!0,renderer.gammaOutput=!0,renderer.shadowMap.enabled=!0,renderer.shadowMap.cullFace=THREE.CullFaceBack,controls=new THREE.OrbitControls(camera,renderer.domElement),controls.addEventListener("change",render),controls.enablePan=!0,controls.target.set(0,0,0),controls.minDistance=100,controls.enableZoom=!0;var e=new THREE.AxisHelper(30);scene.add(e);var n=new THREE.GridHelper(200,10);scene.add(n),container.appendChild(renderer.domElement),window.addEventListener("resize",onWindowResize,!1)}function addShadowedLight(e,n,t,a,r){var o=new THREE.DirectionalLight(a,r);o.position.set(e,n,t),scene.add(o),o.castShadow=!0;var i=1;o.shadowCameraLeft=-i,o.shadowCameraRight=i,o.shadowCameraTop=i,o.shadowCameraBottom=-i,o.shadowCameraNear=1,o.shadowCameraFar=4,o.shadowMapWidth=1024,o.shadowMapHeight=1024,o.shadowBias=-.005}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function render(){renderer.render(scene,camera)}function clearScene(){_.each(_.clone(scene.children),function(e){"Mesh"==e.type&&scene.remove(e)}),render()}var specs={hand:"left",size:100,fname:"Max",lname:"Hova",l1:23,c4:23,design:{name:"",directory:""}},designs=[],hl;$(document).ready(function(){function e(e){return specs.design=e,$.get(e.directory+"manifest.json").then(function(n){hl=new HandLoader(n,e),o()})}function n(e){var n=parseFloat(e.toFixed(1).toString().replace(".","")),t=5*Math.ceil(n/5);return t}function t(e){var n=parseFloat(e.toFixed(1).toString().replace(".","")),t=5*Math.floor(n/5);return t}function a(e){var n=new Date,t=n.getDate()+"-"+(n.getMonth()+1)+"-"+n.getFullYear();return e.lname.replace(/ /g,"")+"_"+e.fname.replace(/ /g,"")+"_forearm_"+e.hand.charAt(0).toUpperCase()+"_"+t+".zip"}function r(e){return{id:e.design.name+e.size+e.hand,name:e.design.name+"_"+e.size+"_"+e.hand,category:e.design.name,variant:e.hand,position:e.size}}function o(){clearScene(),console.log(specs),hl.loadDisplayHand(specs.hand,specs.size,specs.design,function(){ga("ec:addProduct",r(specs)),ga("ec:setAction","checkout",{step:1}),ga("send",{hitType:"event",eventCategory:"HandForge",eventAction:"preview",eventLabel:window.location.host}),render(),setTimeout(function(){render()},500)})}function i(){ga("ec:addProduct",r(specs)),ga("ec:setAction","checkout_option",{step:2}),hl.getFiles(specs.hand,specs.l1,specs.c4,specs.design,function(e){ga("send",{hitType:"event",eventCategory:"HandForge",eventAction:"download",eventLabel:window.location.host}),HandZipper.zip(a(specs),e)},function(e){var n="Some of the files you requested were not available:\n";_.each(e,function(e){n+=e}),alert(n),ga("send","exception",{exDescription:"Incomplete_Hand_"+specs.hand+"_"+specs.size,exFatal:!1})})}$.get("designs.json").then(function(n){designs=n.designs;var t=$("#designSelector");_.each(designs,function(e){t.append("<option value='"+e.name+"'>"+e.name+"</option>")}),t.on("change",function(n){var t=_.findWhere(designs,{name:$(n.target).val()});e(t)}),t.trigger("change")}),$("#flat-slider").slider({orientation:"horizontal",range:!1,value:specs.size,min:100,max:150,step:5,slide:function(e,n){$("#sizeFeedback").text("Size: "+n.value+"%"),hl.setDisplayModelSize(n.value)},stop:function(e,n){specs.size=n.value}});var s=$(".hand-graphic");s.click(function(){s.removeClass("selected"),$(this).addClass("selected"),specs.hand=$(this).data("selectedhand"),hl.flip("right"==specs.hand)}),$(".downloadBtn").click(function(e){e.preventDefault(),specs.fname=$("#fname").val(),specs.lname=$("#lname").val(),specs.l1=n(Math.round(10*$("#L1").val())/10),specs.c4=t(Math.round(10*$("#C4").val())/10),i()})}),Detector.webgl||Detector.addGetWebGLMessage();var container,controls,camera,cameraTarget,scene,renderer;init();var HandLoader=function(e,n){function t(n,t,a,r){if("left"!==n&&"right"!==n)throw alert("Expected hand to be either right or left");if("number"!=typeof t||t<0||t>500)throw alert("Expected L1 size to be a number between 22cm - 30cm");if("number"!=typeof a||a<0||a>500)throw alert("Expected C4 size to be a number between 20cm - 30cm");if("object"!=typeof r)throw alert("Expected design to be an object");return _.filter(e.parts,function(e){return e.handedness.indexOf(n)>-1})}function a(n,t,a,c){var d=new THREE.STLLoader;d.load(a.directory+e.displayModel,function(e,n){var t=new THREE.MeshPhongMaterial({color:16733491,specular:1118481,shininess:200});t.side=THREE.DoubleSide;var a=new THREE.Mesh(e,t);a.castShadow=!0,a.receiveShadow=!0,a.rotation.set(.5*-Math.PI,0,0),a.position.set(0,0,0),scene.add(a),i=o=a,s=r(a),c&&c(n)})}function r(e){var n=(new THREE.Geometry).fromBufferGeometry(e.geometry);n.dynamic=!0;for(var t=0,a=n.faces.length;t<a;t++){var r=n.faces[t],o=r.a;r.a=r.c,r.c=o}var i=n.faceVertexUvs[0];for(t=0,a=i.length;t<a;t++){var s=i[t][0];i[t][0]=i[t][2],i[t][2]=s}var c=new THREE.Mesh(n,e.material);return c.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),c.scale.set(-1,1,1),c}if(!e||!e.parts)throw new Error("Expected a manifest with a parts array.");var o,i,s,c=!1;return{loadDisplayHand:function(e,n,t,r){a(e,n,t,r)},setDisplayModelSize:function(e){o&&(o.scale.set((c?-1:1)*e/100,e/100,e/100),render())},flip:function(e){c=e;var n=Math.abs(o.scale.y);s.scale.set(-1*n,n,n),i.scale.set(n,n,n),o=c?s:i;var t=c?i:s;scene.remove(t),scene.add(o),render()},getFiles:function(e,n,a,r,o,i){var s=t(e,n,a,r),c=[],d=0;_.each(s,function(t){!function(){var l=_.template(t.file_name_template)({handedness:e,l1:n,c4:a}),p=r.directory+_.template(t.file_dir_template)({handedness:e,l1:n,c4:a}),u=new XMLHttpRequest;u.addEventListener("load",function(){200==u.status?c.push({name:l,blob:u.response}):i(t.name),d+=1,d==s.length&&o(c)}),u.open("GET",p+l),u.responseType="blob",u.send(null)}()})}}};zip.workerScriptsPath="scripts/extras/zip-js/";var HandZipper=function(e){function n(e){alert(e)}function t(e){var n="tmp.zip";r(TEMPORARY,4294967296,function(t){function a(){t.root.getFile(n,{create:!0},function(n){e(n)})}t.root.getFile(n,null,function(e){e.remove(a,a)},a)})}function a(e){return"function"!=typeof navigator.msSaveBlob?(o.getBlobURL(function(n){var t;t=document.createEvent("MouseEvent"),t.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null);var a=document.createElement("a");a.href=n,a.download=e,document.body.appendChild(a),a.dispatchEvent(t)}),!1):void o.getBlob(function(e){navigator.msSaveBlob(e,filenameInput.value)})}var r=e.webkitRequestFileSystem||e.mozRequestFileSystem||e.requestFileSystem,o=function(){var a,r,o,i,s=e.webkitURL||e.mozURL||e.URL;return{setCreationMethod:function(e){i=e},addFiles:function(e,s,c,d,l){function p(){var n=e[h];n.name=specs.lname.replace(/ /g,"")+"_"+specs.fname.replace(/ /g,"")+"_forearm_"+specs.hand.charAt(0).toUpperCase()+".stl",c(n),r.add(n.name,new zip.BlobReader(n.blob),function(){h++,h<e.length?p():l()},d)}function u(){zip.createWriter(o,function(e){r=e,s(),p()},n)}var h=0;r?p():"Blob"==i?(o=new zip.BlobWriter,u()):t(function(e){a=e,o=new zip.FileWriter(a),u()})},getBlobURL:function(e){r.close(function(n){var t="Blob"==i?s.createObjectURL(n):a.toURL();e(t),r=null})},getBlob:function(e){r.close(e)}}}();o.setCreationMethod("Blob");var i=0;return{zip:function(e,n){o.addFiles(n,function(){i=(new Date).getTime()},function(){},function(e){},function(){var n=(new Date).getTime()-i;console.log("Complete! Total time to compress: "+n+"ms"),a(e)})}}}(this);